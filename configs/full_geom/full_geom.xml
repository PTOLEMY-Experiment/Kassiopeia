
<geometry>

  <define name="electrode_tb_half_length" value="0.5"/>
  <define name="electrode_tb_half_width" value=".045"/>
  <define name="electrode_tb_half_thickness" value="0.001"/>
  <define name="electrode_tb_half_distance" value=".02"/>

  <define name="electrode_side_half_length" value="0.5"/>
  <define name="electrode_side_half_width" value=".01"/>
  <define name="electrode_side_half_thickness" value="0.001"/>
  <define name="electrode_side_half_distance" value=".045"/>

  <!-- world -->

  <cylinder_space name="world_space" z1="-3." z2="3." r="2.5"/>

  <!-- solenoid -->

  <tag name="magnet_tag">
    <cylinder_tube_space
        name="solenoid_space"
        z1="-0.25"
        z2="0.25"
        r1="0.20"
        r2="0.22"
        radial_mesh_count="180"
        />
  </tag>

  <tag name="magnet_tag_edotb">
    <cylinder_tube_space
        name="solenoid_edotb"
        z1="-0.1"
        z2="0.1"
        r1="0.10"
        r2="0.11"
        radial_mesh_count="180"
        />
  </tag>

  <!-- plates -->

  <tag name="electrode_tag">   
    <extruded_poly_loop_surface name="main_tb_poly_loop_surface" zmin="-{[electrode_tb_half_length]}" zmax="{[electrode_tb_half_length]}" extruded_mesh_count="512" extruded_mesh_power="6.3">
      <poly_loop>
        <start_point x="{[electrode_tb_half_width]}" y="-{[electrode_tb_half_thickness]}"/>
        <next_arc x="{[electrode_tb_half_width]}" y="{[electrode_tb_half_thickness]}" radius="{[electrode_tb_half_thickness]}" right="true" short="false" arc_mesh_count="64"/>
        <next_line x="-{[electrode_tb_half_width]}" y="{[electrode_tb_half_thickness]}" line_mesh_count="64" line_mesh_power="2.5"/>
        <next_arc x="-{[electrode_tb_half_width]}" y="-{[electrode_tb_half_thickness]}" radius="{[electrode_tb_half_thickness]}" right="true" short="false" arc_mesh_count="64"/>
        <last_line line_mesh_count="64" line_mesh_power="2.5"/>
      </poly_loop>
    </extruded_poly_loop_surface>

    <extruded_poly_loop_surface name="cap_tb_poly_loop_surface" zmin="-{[electrode_tb_half_width]}" zmax="{[electrode_tb_half_width]}" extruded_mesh_count="64" extruded_mesh_power="6.3">
      <poly_loop>
        <start_point x="0.0" y="-{[electrode_tb_half_thickness]}"/>
        <next_arc x="0.0" y="{[electrode_tb_half_thickness]}" radius="{[electrode_tb_half_thickness]}" right="true" short="false" arc_mesh_count="64"/>
        <last_line line_mesh_count="64" line_mesh_power="2.5"/>
      </poly_loop>
    </extruded_poly_loop_surface>

    <rotated_circle_surface name="corner_tb_circle_surface" rotated_mesh_count="64">
      <circle x="0.0" y="0.0" radius="{[electrode_tb_half_thickness]}" circle_mesh_count="64"/>
    </rotated_circle_surface>

    <!-- side -->

    <extruded_poly_loop_surface name="main_side_poly_loop_surface" zmin="-{[electrode_side_half_length]}" zmax="{[electrode_side_half_length]}" extruded_mesh_count="512" extruded_mesh_power="6.3">
      <poly_loop>
        <start_point x="{[electrode_side_half_width]}" y="-{[electrode_side_half_thickness]}"/>
        <next_arc x="{[electrode_side_half_width]}" y="{[electrode_side_half_thickness]}" radius="{[electrode_side_half_thickness]}" right="true" short="false" arc_mesh_count="64"/>
        <next_line x="-{[electrode_side_half_width]}" y="{[electrode_side_half_thickness]}" line_mesh_count="64" line_mesh_power="2.5"/>
        <next_arc x="-{[electrode_side_half_width]}" y="-{[electrode_side_half_thickness]}" radius="{[electrode_side_half_thickness]}" right="true" short="false" arc_mesh_count="64"/>
        <last_line line_mesh_count="64" line_mesh_power="2.5"/>
      </poly_loop>
    </extruded_poly_loop_surface>

    <extruded_poly_loop_surface name="cap_side_poly_loop_surface" zmin="-{[electrode_side_half_width]}" zmax="{[electrode_side_half_width]}" extruded_mesh_count="64" extruded_mesh_power="6.3">
      <poly_loop>
        <start_point x="0.0" y="-{[electrode_side_half_thickness]}"/>
        <next_arc x="0.0" y="{[electrode_side_half_thickness]}" radius="{[electrode_side_half_thickness]}" right="true" short="false" arc_mesh_count="64"/>
        <last_line line_mesh_count="64" line_mesh_power="2.5"/>
      </poly_loop>
    </extruded_poly_loop_surface>

    <rotated_circle_surface name="corner_side_circle_surface" rotated_mesh_count="64">
      <circle x="0.0" y="0.0" radius="{[electrode_side_half_thickness]}" circle_mesh_count="64"/>
    </rotated_circle_surface>
  </tag>

  <!-- target -->

  <tag name="target_tag">
    <flattened_poly_loop_surface name="target_surface" z="0.0" flattened_mesh_count="60" flattened_mesh_power="3.0">
      <poly_loop>
	<start_point x="0.1" y="0.05"/>
	<next_line x="0.1" y="-0.05" line_mesh_count="10" line_mesh_power="2.5"/>
	<next_line x="-0.1" y="-0.05" line_mesh_count="60" line_mesh_power="2.5"/>
	<next_line x="-0.1" y="0.05" line_mesh_count="10" line_mesh_power="2.5"/>
	<last_line line_mesh_count="60" line_mesh_power="2.5"/>
      </poly_loop>
    </flattened_poly_loop_surface>

    <flattened_poly_loop_surface name="target2_surface" z="0.0" flattened_mesh_count="32" flattened_mesh_power="3.0">
      <poly_loop>
	<start_point x="0.005" y="0.005"/>
	<next_line x="0.005" y="-0.005" line_mesh_count="32" line_mesh_power="2.5"/>
	<next_line x="-0.005" y="-0.005" line_mesh_count="32" line_mesh_power="2.5"/>
	<next_line x="-0.005" y="0.005" line_mesh_count="32" line_mesh_power="2.5"/>
	<last_line line_mesh_count="32" line_mesh_power="2.5"/>
      </poly_loop>
    </flattened_poly_loop_surface>

    <flattened_poly_loop_surface name="target3_surface" z="0.0" flattened_mesh_count="32" flattened_mesh_power="3.0">
      <poly_loop>
	<start_point x="0.005" y="{[electrode_tb_half_distance]-0.001}"/>
	<next_line x="0.005" y="-{[electrode_tb_half_distance]-0.001}" line_mesh_count="32" line_mesh_power="2.5"/>
	<next_line x="-0.005" y="-{[electrode_tb_half_distance]-0.001}" line_mesh_count="32" line_mesh_power="2.5"/>
	<next_line x="-0.005" y="{[electrode_tb_half_distance]-0.001}" line_mesh_count="32" line_mesh_power="2.5"/>
	<last_line line_mesh_count="32" line_mesh_power="2.5"/>
      </poly_loop>
    </flattened_poly_loop_surface>

    <flattened_poly_loop_surface name="target_ext_surface" z="0.0" flattened_mesh_count="60" flattened_mesh_power="3.0">
      <poly_loop>
	<start_point x="0.0005" y="0.02"/>
	<next_line x="0.0005" y="-0.02" line_mesh_count="60" line_mesh_power="2.5"/>
	<next_line x="-0.0005" y="-0.02" line_mesh_count="10" line_mesh_power="2.5"/>
	<next_line x="-0.0005" y="0.02" line_mesh_count="60" line_mesh_power="2.5"/>
	<last_line line_mesh_count="10" line_mesh_power="2.5"/>
      </poly_loop>
    </flattened_poly_loop_surface>
  </tag>

  <!-- catcher -->

  <tag name="catcher_tag">
    <disk_surface name="catcher_surface" r="0.02" z="0."/>
    <flattened_poly_loop_surface name="catcher_ext_surface" z="0.0" flattened_mesh_count="60" flattened_mesh_power="3.0">
      <poly_loop>
	<start_point x="0.06" y="0.02"/>
	<next_line x="0.06" y="-0.02" line_mesh_count="10" line_mesh_power="2.5"/>
	<next_line x="-0.06" y="-0.02" line_mesh_count="60" line_mesh_power="2.5"/>
	<next_line x="-0.06" y="0.02" line_mesh_count="10" line_mesh_power="2.5"/>
	<last_line line_mesh_count="60" line_mesh_power="2.5"/>
      </poly_loop>
    </flattened_poly_loop_surface>
  </tag>

  <!-- fence -->

  <tag name="electrode_tag">
    <flattened_circle_surface name="fence_tb_surface" z="0." flattened_mesh_count="10" flattened_mesh_power="4.">
      <circle x="0." y="0." radius="0.5" circle_mesh_count="128"/>
    </flattened_circle_surface>
    <cylinder_surface
    	name="fence_side_surface"
        z1="-1.0"
        z2="1.0"
        r="0.5"
    	longitudinal_mesh_count="100"
        longitudinal_mesh_power="3."
        axial_mesh_count="128"
        />
  </tag>

  <!-- assembly -->

  <space name="setup_assembly">

    <!-- fence -->

    <tag name="fence_tag">
    <surface name="fence_side" node="fence_side_surface"/>
    <surface name="fence_top" node="fence_tb_surface">
      <transformation displacement="0. 0. 1.0"/>
    </surface>
    <surface name="fence_bot" node="fence_tb_surface">
      <transformation displacement="0. 0. -1.0"/>
    </surface>
    </tag>

    <!--  <transformation displacement="{-([electrode_side_half_distance]-[electrode_side_half_thickness]-0.0001)} 0.007 {[electrode_tb_half_length]-0.02}"/>  -->

    <!--
    <surface name="target" node="target2_surface">
      <transformation rotation_euler="90. 90. 90."/>
      <transformation displacement="0. 0.015 {[electrode_tb_half_length]-0.05}"/>
    </surface>
    -->

    <surface name="target" node="target3_surface">
      <transformation rotation_euler="90. 90. 90."/>
      <transformation displacement="0. 0. {[electrode_tb_half_length]-0.45}"/>
    </surface>

    <surface name="catcher_downstream" node="catcher_ext_surface">
      <transformation rotation_euler="0. 0. 0."/>
      <transformation displacement="0. 0. -10."/>
    </surface>

    <surface name="catcher_upstream" node="catcher_ext_surface">
      <transformation rotation_euler="0. 0. 0."/>
      <transformation displacement="0. 0.0 {[electrode_tb_half_length]-0.43}"/>
    </surface>

    <!-- electrodes -->

    <!-- top -->

    <tag name="electrode1_tag">
    <surface name="electrode1_tb_surface" node="main_tb_poly_loop_surface">
      <transformation displacement="0.0 {[electrode_tb_half_distance]} 0.0"/>
    </surface>
    <surface name="electrode1_cap_top_surface" node="cap_tb_poly_loop_surface">
      <transformation rotation_euler="90. 90. 90."/>
      <transformation displacement="0. {[electrode_tb_half_distance]} {[electrode_tb_half_length]}"/>
    </surface>
    <surface name="electrode1_cap_bot_surface" node="cap_tb_poly_loop_surface">
      <transformation rotation_euler="90. 90. 270."/>
      <transformation displacement="0. {[electrode_tb_half_distance]} -{[electrode_tb_half_length]}"/>
    </surface>
    <surface name="electrode1_corner_surface_1" node="corner_tb_circle_surface">
      <transformation displacement="{[electrode_tb_half_width]} {[electrode_tb_half_distance]} {[electrode_tb_half_length]}"/>
    </surface>
    <surface name="electrode1_corner_surface_2" node="corner_tb_circle_surface">
      <transformation displacement="{[electrode_tb_half_width]} {[electrode_tb_half_distance]} -{[electrode_tb_half_length]}"/>
    </surface>
    <surface name="electrode1_corner_surface_3" node="corner_tb_circle_surface">
      <transformation displacement="-{[electrode_tb_half_width]} {[electrode_tb_half_distance]} -{[electrode_tb_half_length]}"/>
    </surface>
    <surface name="electrode1_corner_surface_4" node="corner_tb_circle_surface">
      <transformation displacement="-{[electrode_tb_half_width]} {[electrode_tb_half_distance]} {[electrode_tb_half_length]}"/>
    </surface>
    </tag>

    <!-- bottom -->

    <tag name="electrode2_tag">
    <surface name="electrode2_tb_surface" node="main_tb_poly_loop_surface">
      <transformation displacement="0.0 -{[electrode_tb_half_distance]} 0.0"/>
    </surface>
    <surface name="electrode2_cap_top_surface" node="cap_tb_poly_loop_surface">
      <transformation rotation_euler="90. 90. 90."/>
      <transformation displacement="0. -{[electrode_tb_half_distance]} {[electrode_tb_half_length]}"/>
    </surface>
    <surface name="electrode2_cap_bot_surface" node="cap_tb_poly_loop_surface">
      <transformation rotation_euler="90. 90. 270."/>
      <transformation displacement="0. -{[electrode_tb_half_distance]} -{[electrode_tb_half_length]}"/>
    </surface>
    <surface name="electrode2_corner_surface_1" node="corner_tb_circle_surface">
      <transformation displacement="{[electrode_tb_half_width]} -{[electrode_tb_half_distance]} {[electrode_tb_half_length]}"/>
    </surface>
    <surface name="electrode2_corner_surface_2" node="corner_tb_circle_surface">
      <transformation displacement="{[electrode_tb_half_width]} -{[electrode_tb_half_distance]} -{[electrode_tb_half_length]}"/>
    </surface>
    <surface name="electrode2_corner_surface_3" node="corner_tb_circle_surface">
      <transformation displacement="-{[electrode_tb_half_width]} -{[electrode_tb_half_distance]} -{[electrode_tb_half_length]}"/>
    </surface>
    <surface name="electrode2_corner_surface_4" node="corner_tb_circle_surface">
      <transformation displacement="-{[electrode_tb_half_width]} -{[electrode_tb_half_distance]} {[electrode_tb_half_length]}"/>
    </surface>
    </tag>

    <!-- left -->

    <tag name="electrode3_tag">
    <surface name="electrode3_side_surface" node="main_side_poly_loop_surface">
      <transformation rotation_euler="0. 0. 90."/>
      <transformation displacement="-{[electrode_side_half_distance]} 0.0 0.0"/>
    </surface>
    <surface name="electrode3_cap_top_surface" node="cap_side_poly_loop_surface">
      <transformation rotation_euler="0. 90. 90."/>
      <transformation displacement=" -{[electrode_side_half_distance]} 0. {[electrode_side_half_length]}"/>
    </surface>
    <surface name="electrode3_cap_bot_surface" node="cap_side_poly_loop_surface">
      <transformation rotation_euler="0. 90. 270."/>
      <transformation displacement="-{[electrode_side_half_distance]} 0. -{[electrode_side_half_length]}"/>
    </surface>
    <surface name="electrode3_corner_surface_1" node="corner_side_circle_surface">
      <transformation displacement="-{[electrode_side_half_distance]} {[electrode_side_half_width]} {[electrode_side_half_length]}"/>
    </surface>
    <surface name="electrode3_corner_surface_2" node="corner_side_circle_surface">
      <transformation displacement="-{[electrode_side_half_distance]} {[electrode_side_half_width]} -{[electrode_side_half_length]}"/>
    </surface>
    <surface name="electrode3_corner_surface_3" node="corner_side_circle_surface">
      <transformation displacement="-{[electrode_side_half_distance]} -{[electrode_side_half_width]} -{[electrode_side_half_length]}"/>
    </surface>
    <surface name="electrode3_corner_surface_4" node="corner_side_circle_surface">
      <transformation displacement="-{[electrode_side_half_distance]} -{[electrode_side_half_width]} {[electrode_side_half_length]}"/>
    </surface>
    </tag>

    <!-- right -->

    <tag name="electrode4_tag">
    <surface name="electrode4_side_surface" node="main_side_poly_loop_surface">
      <transformation rotation_euler="0. 0. 90."/>
      <transformation displacement="{[electrode_side_half_distance]} 0.0 0.0"/>
    </surface>
    <surface name="electrode4_cap_top_surface" node="cap_side_poly_loop_surface">
      <transformation rotation_euler="0. 90. 90."/>
      <transformation displacement=" {[electrode_side_half_distance]} 0. {[electrode_side_half_length]}"/>
    </surface>
    <surface name="electrode4_cap_bot_surface" node="cap_side_poly_loop_surface">
      <transformation rotation_euler="0. 90. 270."/>
      <transformation displacement="{[electrode_side_half_distance]} 0. -{[electrode_side_half_length]}"/>
    </surface>
    <surface name="electrode4_corner_surface_1" node="corner_side_circle_surface">
      <transformation displacement="{[electrode_side_half_distance]} {[electrode_side_half_width]} {[electrode_side_half_length]}"/>
    </surface>
    <surface name="electrode4_corner_surface_2" node="corner_side_circle_surface">
      <transformation displacement="{[electrode_side_half_distance]} {[electrode_side_half_width]} -{[electrode_side_half_length]}"/>
    </surface>
    <surface name="electrode4_corner_surface_3" node="corner_side_circle_surface">
      <transformation displacement="{[electrode_side_half_distance]} -{[electrode_side_half_width]} -{[electrode_side_half_length]}"/>
    </surface>
    <surface name="electrode4_corner_surface_4" node="corner_side_circle_surface">
      <transformation displacement="{[electrode_side_half_distance]} -{[electrode_side_half_width]} {[electrode_side_half_length]}"/>
    </surface>
    </tag>
  </space>

  <space name="world" node="world_space">
    <space name="exb_setup" tree="setup_assembly"/>
  </space>

  <!-- appearance -->

  <appearance name="app_electrode" color="240 255   0 127" arc="72" surfaces="world/exb_setup/@electrode1_tag"/>
  <appearance name="app_electrode" color="255 255   0 127" arc="72" surfaces="world/exb_setup/@electrode2_tag"/>
  <appearance name="app_electrode" color="  0 255   0 127" arc="72" surfaces="world/exb_setup/@electrode3_tag"/>
  <appearance name="app_electrode" color="  0 255   0 127" arc="72" surfaces="world/exb_setup/@electrode4_tag"/>

</geometry>

