<define name="prefix" value="penning_1cm_rotated"/>
<define name="output_path" value="[KASPERSYS]/output/Kassiopeia/[prefix]"/>
<define name="log_path" value="[KASPERSYS]/log/Kassiopeia"/>

<external_define name="run_id" value="0"/>
<external_define name="seed" value="78797"/>
<external_define name="events" value="1"/>
<external_define name="n_steps" value="40000000"/>

<external_define name="pitch" value="70."/>
<external_define name="phi" value="90."/>

<external_define name="x" value="0."/>
<external_define name="y" value="-0.003"/>
<external_define name="z" value="0."/>

<external_define name="bumper_voltage" value="-20000."/>
<external_define name="intermediate_voltage" value="-1000."/>
<external_define name="center_voltage" value="-10."/>

<define name="filename" value="[prefix]_[bumper_voltage]_[intermediate_voltage]_[center_voltage]"/>


<messages>
	<file path="[log_path]" base="[filename]_[n_steps]_log.txt"/>

	<message key="k_file" terminal="normal" log="warning"/>
	<message key="k_initialization" terminal="normal" log="warning"/>

	<message key="kg_core" terminal="normal" log="warning"/>
	<message key="kg_shape" terminal="normal" log="warning"/>
	<message key="kg_mesh" terminal="normal" log="warning"/>
	<message key="kg_axial_mesh" terminal="normal" log="warning"/>

	<message key="ks_object" terminal="normal" log="normal"/>
	<message key="ks_operator" terminal="normal" log="normal"/>
	<message key="ks_field" terminal="normal" log="normal"/>
	<message key="ks_geometry" terminal="normal" log="normal"/>
	<message key="ks_generator" terminal="normal" log="normal"/>
	<message key="ks_trajectory" terminal="normal" log="normal"/>
	<message key="ks_interaction" terminal="normal" log="normal"/>
	<message key="ks_navigator" terminal="normal" log="normal"/>
	<message key="ks_terminator" terminal="normal" log="normal"/>
	<message key="ks_writer" terminal="normal" log="normal"/>
	<message key="ks_main" terminal="normal" log="normal"/>
	<message key="ks_run" terminal="normal" log="normal"/>
	<message key="ks_event" terminal="normal" log="normal"/>
	<message key="ks_track" terminal="normal" log="normal"/>
	<message key="ks_step" terminal="normal" log="normal"/>

</messages>

<include name="[prefix]_geom.xml"/>

<geometry>

	<mesh name="mesh_electrode" surfaces="world/electrode_space/@shape_tag"/>
	<mesh name="mesh_electrode" surfaces="world/fence_space/@shape_tag"/>
<!-- top -->
	<electrostatic_dirichlet name="telec_side_ground_plate1" surfaces="world/electrode_space/@tside_ground_plate1" value="0."/>
	<electrostatic_dirichlet name="telec_side_ground_plate1" surfaces="world/electrode_space/@tside_ground_plate2" value="0."/>

	<electrostatic_dirichlet name="telec_bumper_plate1" surfaces="world/electrode_space/@tbumper_plate1" value="[bumper_voltage]"/>
	<electrostatic_dirichlet name="telec_bumper_plate2" surfaces="world/electrode_space/@tbumper_plate2" value="[bumper_voltage]"/>

	<electrostatic_dirichlet name="telec_intermediate_plate1" surfaces="world/electrode_space/@tintermediate_plate1" value="[intermediate_voltage]"/>
	<electrostatic_dirichlet name="telec_intermediate_plate2" surfaces="world/electrode_space/@tintermediate_plate2" value="[intermediate_voltage]"/>

	<electrostatic_dirichlet name="telec_center_plate" surfaces="world/electrode_space/@tcenter_plate" value="0."/>

<!-- bottom -->
	<electrostatic_dirichlet name="belec_side_ground_plate1" surfaces="world/electrode_space/@bside_ground_plate1" value="0."/>
	<electrostatic_dirichlet name="belec_side_ground_plate1" surfaces="world/electrode_space/@bside_ground_plate2" value="0."/>

	<electrostatic_dirichlet name="belec_bumper_plate1" surfaces="world/electrode_space/@bbumper_plate1" value="[bumper_voltage]"/>
	<electrostatic_dirichlet name="belec_bumper_plate2" surfaces="world/electrode_space/@bbumper_plate2" value="[bumper_voltage]"/>

	<electrostatic_dirichlet name="belec_intermediate_plate1" surfaces="world/electrode_space/@bintermediate_plate1" value="[intermediate_voltage]"/>
	<electrostatic_dirichlet name="belec_intermediate_plate2" surfaces="world/electrode_space/@bintermediate_plate2" value="[intermediate_voltage]"/>

	<electrostatic_dirichlet name="belec_center_plate" surfaces="world/electrode_space/@bcenter_plate" value="[center_voltage]"/>

</geometry>

<kassiopeia>

<!-- fields -->

	<ksfield_magnetic_constant name="magnetic_constant" field="0. 0. 1."/>

	<ksfield_electrostatic
		name="field_electrostatic"
		directory="[KEMFIELD_CACHE]"
		file="[filename].kbd"
		system="world" 
		surfaces="world/@shape_tag"
		symmetry="none"
		minimum_element_area="1e-15"
		maximum_element_aspect_ratio="50">

<!-- 		<viewer
			file="[output_path]/[filename].vtp"
			view="false"
			save="false"
			preprocessing="true"
			postprocessing="true"/> -->
		<krylov_bem_solver
			solver_name="gmres"
			preconditioner="implicit_krylov"
			tolerance="2e-6"
			preconditioner_tolerance="0.01"
			max_iterations="500"
			max_preconditioner_iterations="30"
			iterations_between_restarts="250"
			preconditioner_degree="1"
			intermediate_save_interval="1"
			use_display="true"
			show_plot="false"
			use_timer="true">
			<fftm_multiplication
				verbosity="3"
				strategy="balanced"
				top_level_divisions="10"
				tree_level_divisions="4"
				expansion_degree="7"
				bias_degree="1"
				neighbor_order="1"
				maximum_tree_depth="9"
				use_region_size_estimation="true"
				use_caching="true"
				region_expansion_factor="1.1"
				insertion_ratio="1.3333333"
				world_cube_center_x="0.0"
				world_cube_center_y="0.0"
				world_cube_center_z="0.0"
				world_cube_length="0.0"/>
			<preconditioner_electrostatic_parameters
				verbosity="3"
				top_level_divisions="4"
				tree_level_divisions="3"
				expansion_degree="0"
				neighbor_order="1"
				maximum_tree_depth="5"
				use_region_size_estimation="true"
				use_caching="true"
				region_expansion_factor="1.1"
				insertion_ratio="1.3333333"
				world_cube_center_x="0.0"
				world_cube_center_y="0.0"
				world_cube_center_z="0.0"
				world_cube_length="0.0"/>
		</krylov_bem_solver>
		<fast_multipole_field_solver
			top_level_divisions="10"
			tree_level_divisions="4"
			expansion_degree="8"
			neighbor_order="1"
			maximum_tree_depth="6"
			region_expansion_factor="2"
			use_region_size_estimation="true"
			use_caching="true"
			verbosity="3"
			use_opencl="true"/>
	</ksfield_electrostatic>

	<!-- generators -->

	<ksgen_generator_composite name="generator_uniform" pid="11">
		<energy_composite>
			<energy_fix value="18600."/>
		</energy_composite>
		<position_rectangular_composite>
			<x_fix value="[x]"/>
			<y_fix value="[y]"/>
			<z_fix value="[z]"/>
		</position_rectangular_composite>
		<direction_spherical_composite>
			<theta_fix value="[pitch]"/>
			<phi_fix value="[phi]"/>
		</direction_spherical_composite>
		<time_composite>
			<time_fix value="0"/>
		</time_composite>
	</ksgen_generator_composite>

	<!-- trajectories-->

	<kstraj_trajectory_exact name="trajectory_exact">
		<interpolator_crk name="interpolator_crk"/>
		<integrator_rk8 name="integrator_rk8"/>
		<term_propagation name="term_propagation"/>
		<control_cyclotron name="control_cyclotron_1_64" fraction="{1. / 64.}"/>
		<control_time name="control_time" time="5.e-9"/>
	</kstraj_trajectory_exact>

	<!-- space navigators -->

	<ksnav_space name="nav_space" enter_split="false" exit_split="false"/>

	<!-- surface navigators -->

	<ksnav_surface name="nav_surface" transmission_split="false" reflection_split="false"/>

	<!-- terminators -->
	<ksterm_death name="term_electrode"/>
	<ksterm_death name="term_world"/>
	<ksterm_death name="term_fence"/>
	<ksterm_max_steps name="term_max_steps" steps="[n_steps]"/>

    <!-- modifiers -->
	<cycl_rad_extr name="my_rad_extr" P8Phase="1"/>

	<!-- writers -->

	<kswrite_root name="write_root" path="[output_path]" base="[filename]_[n_steps].root"/>
	<kswrite_vtk name="write_vtk" path="[output_path]" base="[filename]_[n_steps]"/>

	<!-- output -->
<!--
	<ks_component_member name="component_track_initial_particle" field="initial_particle" parent="track"/>
	<ks_component_member name="component_track_final_particle" field="final_particle" parent="track"/>
	<ks_component_member name="component_track_position" field="position" parent="component_track_final_particle"/>
	<ks_component_member name="component_track_length" field="length" parent="component_track_final_particle"/>

	<ks_component_group name="component_track_world">
		<component_member name="this_track_id" field="track_id" parent="track"/>
		<component_member name="parent_track_id" field="parent_track_id" parent="component_track_initial_particle"/>
		<component_member name="creator_name" field="creator_name" parent="track"/>
		<component_member name="terminator_name" field="terminator_name" parent="track"/>
		<component_member name="continuous_time" field="continuous_time" parent="track"/>
		<component_member name="continuous_length" field="continuous_length" parent="track"/>
		<component_member name="total_steps" field="total_steps" parent="track"/>
		<component_member name="initial_time" field="time" parent="component_track_initial_particle"/>
		<component_member name="initial_position" field="position" parent="component_track_initial_particle"/>
		<component_member name="initial_guiding_center_position" field="guiding_center_position" parent="component_track_initial_particle"/>

		<component_member name="initial_momentum" field="momentum" parent="component_track_initial_particle"/>
		<component_member name="initial_magnetic_field" field="magnetic_field" parent="component_track_initial_particle"/>
		<component_member name="initial_electric_field" field="electric_field" parent="component_track_initial_particle"/>
		<component_member name="initial_electric_potential" field="electric_potential" parent="component_track_initial_particle"/>
		<component_member name="initial_kinetic_energy" field="kinetic_energy_ev" parent="component_track_initial_particle"/>
		<component_member name="initial_cyclotron_frequency" field="cyclotron_frequency" parent="component_track_initial_particle"/>

		<component_member name="initial_orbital_magnetic_moment"  field="orbital_magnetic_moment" parent="component_track_initial_particle"/>
		<component_member name="initial_polar_angle_to_z" field="polar_angle_to_z" parent="component_track_initial_particle"/>
		<component_member name="initial_polar_angle_to_b" field="polar_angle_to_b" parent="component_track_initial_particle"/>
		<component_member name="final_time" field="time" parent="component_track_final_particle"/>
		<component_member name="final_position" field="position" parent="component_track_final_particle"/>
		<component_member name="final_guiding_center_position" field="guiding_center_position" parent="component_track_final_particle"/>

		<component_member name="final_momentum" field="momentum" parent="component_track_final_particle"/>
		<component_member name="final_magnetic_field" field="magnetic_field" parent="component_track_final_particle"/>
		<component_member name="final_electric_field" field="electric_field" parent="component_track_final_particle"/>
		<component_member name="final_electric_potential" field="electric_potential" parent="component_track_final_particle"/>
		<component_member name="final_kinetic_energy" field="kinetic_energy_ev" parent="component_track_final_particle"/>
		<component_member name="final_orbital_magnetic_moment" field="orbital_magnetic_moment" parent="component_track_final_particle"/>
		<component_member name="final_cyclotron_frequency" field="cyclotron_frequency" parent="component_track_final_particle"/>
		<component_member name="final_polar_angle_to_z" field="polar_angle_to_z" parent="component_track_final_particle"/>
		<component_member name="final_polar_angle_to_b" field="polar_angle_to_b" parent="component_track_final_particle"/>
	</ks_component_group>
-->

	<ks_component_member name="component_step_final_particle" field="final_particle" parent="step"/>  
	<ks_component_member name="component_step_position" field="position" parent="component_step_final_particle"/>
	<ks_component_member name="component_step_length" field="length" parent="component_step_final_particle"/>

	<ks_component_group name="component_step_world">
		<component_member name="step_id" field="step_id" parent="step"/>
		<component_member name="continuous_time" field="continuous_time" parent="step"/>
		<component_member name="continuous_length" field="continuous_length" parent="step"/>
		<component_member name="time" field="time" parent="component_step_final_particle"/>
		<component_member name="position" field="position" parent="component_step_final_particle"/>
		<component_member name="velocity" field="velocity" parent="component_step_final_particle"/>
		<component_member name="trans_velocity" field="trans_velocity" parent="component_step_final_particle"/>
		<component_member name="long_velocity" field="long_velocity" parent="component_step_final_particle"/>
		<component_member name="momentum" field="momentum" parent="component_step_final_particle"/>
		<component_member name="trans_momentum" field="trans_momentum" parent="component_step_final_particle"/>
		<component_member name="long_momentum" field="long_momentum" parent="component_step_final_particle"/>
		<component_member name="magnetic_field" field="magnetic_field" parent="component_step_final_particle"/>
		<component_member name="magnetic_gradient" field="magnetic_gradient" parent="component_step_final_particle"/>
		<component_member name="electric_field" field="electric_field" parent="component_step_final_particle"/>
		<component_member name="electric_potential" field="electric_potential" parent="component_step_final_particle"/>
		<component_member name="kinetic_energy" field="kinetic_energy_ev" parent="component_step_final_particle"/>
		<component_member name="orbital_magnetic_moment" field="orbital_magnetic_moment"  parent="component_step_final_particle"/>
		<component_member name="polar_angle_to_z" field="polar_angle_to_z" parent="component_step_final_particle"/>
		<component_member name="polar_angle_to_b" field="polar_angle_to_b" parent="component_step_final_particle"/>
		<component_member name="cyclotron_frequency" field="cyclotron_frequency" parent="component_step_final_particle"/>
		<component_member name="guiding_center_position" field="guiding_center_position"  parent="component_step_final_particle"/>
		<component_member name="azimuthal_angle_to_x" field="azimuthal_angle_to_x" parent="component_step_final_particle"/>
		<component_member name="lorentz_factor" field="lorentz_factor " parent="component_step_final_particle"/>
		<component_member name="speed" field="speed" parent="component_step_final_particle"/>
	</ks_component_group>

	<!-- structure -->

	<ksgeo_space name="space_world" spaces="world">
		<command parent="root_step_modifier" field="add_modifier" child="my_rad_extr"/>

		<command parent="root_terminator" field="add_terminator"    child="term_max_steps"/>
		<command parent="root_terminator" field="remove_terminator" child="term_world"/>

		<command parent="write_root" field="add_step_output"     child="component_step_world"/>

		<command parent="write_vtk" field="set_step_point" child="component_step_position"/>
		<command parent="write_vtk" field="set_step_data" child="component_step_length"/>

		<geo_surface name="surface_fence" surfaces="world/fence_space/fence_surface">
			<command parent="root_terminator" field="add_terminator" child="term_fence"/>
		</geo_surface>

		<geo_surface name="surface_electrodes" surfaces="world/electrode_space/@shape_tag">
			<command parent="root_terminator" field="add_terminator" child="term_fence"/>
		</geo_surface>

	</ksgeo_space>

	<!-- simulation -->

	<ks_simulation
		run="[run_id]"
		seed="[seed]"
		events="[events]"
		magnetic_field="magnetic_constant"
		electric_field="field_electrostatic"
		space="space_world"
		generator="generator_uniform"
		trajectory="trajectory_exact"
		space_navigator="nav_space"
		surface_navigator="nav_surface"
		terminator="term_world"
		writer="write_root"
		writer="write_vtk"/>

</kassiopeia>

<vtk_window
	name="vtk_window"
	enable_display="false"
	enable_write="true"
	frame_title="KGeoBag Visualization"
	frame_size_x="1024"
	frame_size_y="768"
	frame_color_red=".2"
	frame_color_green=".2"
	frame_color_blue=".2"
	view_angle="45"
	eye_angle="0.5"
	multi_samples="4"
	depth_peeling="10">
	<vtk_track_painter
		name="[filename]_[n_steps]_track_painter"
		path="[output_path]"
		file="[filename]_[n_steps].root"
		point_object="component_step_world"
		point_variable="position"
		color_object="component_step_world"
		color_variable="polar_angle_to_b"/>
</vtk_window>