<define name="output_path" value="[KASPERSYS]/output/Kassiopeia"/>
<define name="log_path" value="[KASPERSYS]/log/Kassiopeia"/>

<messages>
  <file path="[log_path]" base="PTolemy.txt"/>

  <message key="k_file" terminal="normal" log="warning"/>
  <message key="k_initialization" terminal="normal" log="warning"/>

  <message key="kg_core" terminal="normal" log="warning"/>
  <message key="kg_shape" terminal="normal" log="warning"/>
  <message key="kg_mesh" terminal="normal" log="warning"/>
  <message key="kg_axial_mesh" terminal="normal" log="warning"/>

  <message key="ks_object" terminal="normal" log="normal"/>
  <message key="ks_operator" terminal="normal" log="normal"/>
  <message key="ks_field" terminal="normal" log="normal"/>
  <message key="ks_geometry" terminal="normal" log="normal"/>
  <message key="ks_generator" terminal="normal" log="normal"/>
  <message key="ks_trajectory" terminal="normal" log="normal"/>
  <message key="ks_interaction" terminal="normal" log="normal"/>
  <message key="ks_navigator" terminal="normal" log="normal"/>
  <message key="ks_terminator" terminal="normal" log="normal"/>
  <message key="ks_writer" terminal="normal" log="normal"/>
  <message key="ks_main" terminal="normal" log="normal"/>
  <message key="ks_run" terminal="normal" log="normal"/>
  <message key="ks_event" terminal="normal" log="normal"/>
  <message key="ks_track" terminal="normal" log="normal"/>
  <message key="ks_step" terminal="normal" log="normal"/>

</messages>

<geometry>

  <!-- world -->

  <cylinder_space name="world_space" z1="-5." z2="5." r="5."/>
  
  <!-- center -->

  <tag name="center_tag">
    <disk_surface name="center_surface" r="25.0e-2" z="0."/>
  </tag>

  <tag name="target_tag">
    <disk_surface name="target" r="10.0e-2" z="0."/>
  </tag>

  <!-- tritium source -->

  <tag name="tritium_tag">
    <disk_surface name="tritium_source" r="1.6e-2" z="0."/>
  </tag>

  <!--calorimeter -->

  <tag name="calorimeter_tag">
    <disk_surface name="calorimeter_surface" r="10.0e-2" z="0."/>
  </tag>

  <!-- electrodes -->

  <tag name="electrode_tag">
    <tag name="pre_cylinder_tag">
      <cylinder_surface
    	  name="pre_cylinder_surface"
    	  z1="-46.9985e-2"
    	  z2="46.9985e-2"
	  r="6.0325e-2"
    	  longitudinal_mesh_count="200" longitudinal_mesh_power="3."
          axial_mesh_count="128"
          />
    </tag>

    <tag name="pre_cone_tag">
      <cut_cone_surface
    	  name="pre_cone_surface"
    	  z1="-6.1965e-2"    r1="7.3025e-2"
    	  z2="6.1965e-2"    r2="17.82e-2"
    	  longitudinal_mesh_count="200" longitudinal_mesh_power="3."
          axial_mesh_count="128"
          />
    </tag>

    <tag name="upstream_cylinder_tag">
      <cylinder_surface
    	  name="upstream_cylinder_surface"
    	  z1="-4.447e-2"
    	  z2="4.447e-2"
	  r="17.82e-2"
    	  longitudinal_mesh_count="200" longitudinal_mesh_power="3."
          axial_mesh_count="128"
          />
    </tag>

    <tag name="upstream_cone_tag">
      <cut_cone_surface
    	  name="upstream_cone_surface"
    	  z1="-19.298e-2"    r1="19.07e-2"
    	  z2="19.298e-2"     r2="40.383e-2"
    	  longitudinal_mesh_count="200" longitudinal_mesh_power="3."
          axial_mesh_count="128"
          />
    </tag>

    <tag name="central_cylinder_tag">
      <cylinder_surface
    	  name="central_cylinder_surface"
    	  z1="-30.0e-2"
    	  z2="30.0e-2"
	  r="40.2825e-2"
    	  longitudinal_mesh_count="200" longitudinal_mesh_power="3."
          axial_mesh_count="128"
          />
    </tag>

    <tag name="downstream_cone_tag">
      <cut_cone_surface
    	  name="downstream_cone_surface"
    	  z1="-19.06e-2"     r1="40.283e-2"
    	  z2="19.06e-2"	     r2="18.891e-2"
    	  longitudinal_mesh_count="200" longitudinal_mesh_power="3."
          axial_mesh_count="128"
          />
    </tag>

    <tag name="downstream_cylinder_tag">
      <cylinder_surface
    	  name="downstream_cylinder_surface"
    	  z1="-5.816e-2"
    	  z2="5.816e-2"
	  r="17.463e-2"
    	  longitudinal_mesh_count="200" longitudinal_mesh_power="3."
          axial_mesh_count="128"
          />
    </tag>
    
    <tag name="post_cone_tag">
      <cut_cone_surface
    	  name="post_cone_surface"
    	  z1="-5.8155e-2"    r1="17.463e-2"
    	  z2="5.8155e-2"    r2="12.938e-2"
    	  longitudinal_mesh_count="200" longitudinal_mesh_power="3."
          axial_mesh_count="128"
          />
    </tag>

    <tag name="post_cylinder_tag">
      <cylinder_surface
    	  name="post_cylinder_surface"
    	  z1="-40.6485e-2"
    	  z2="40.6485e-2"
	  r="11.113e-2"
    	  longitudinal_mesh_count="200" longitudinal_mesh_power="3."
          axial_mesh_count="128"
          />
    </tag>
  </tag>
   
  <!-- screen -->
  
  <tag name="screen_tag">
    <rotated_poly_line_surface name="screen_surface" rotated_mesh_count="128">
      <poly_line>
	<start_point x="-1.9288"  y="0.080325"/>
	<next_line x="-0.98883"  y="0.080325" line_mesh_count="128" line_mesh_power="4.5"/>
	<next_line x="-0.96383"  y="0.093025" line_mesh_count="128" line_mesh_power="4.5"/>
	<next_line x="-0.8399"  y="0.1982" line_mesh_count="128" line_mesh_power="4.5"/>
	<next_line x="-0.8149"  y="0.1982" line_mesh_count="128" line_mesh_power="4.5"/>
	<next_line x="-0.72596"  y="0.1982" line_mesh_count="128" line_mesh_power="4.5"/>
	<next_line x="-0.70596"  y="0.2107" line_mesh_count="128" line_mesh_power="4.5"/>
	<next_line x="-0.320"  y="0.42383" line_mesh_count="128" line_mesh_power="4.5"/>
	<next_line x="-0.300"  y="0.422825" line_mesh_count="128" line_mesh_power="4.5"/>
	<next_line x="0.300"  y="0.422825" line_mesh_count="128" line_mesh_power="4.5"/>
	<next_line x="0.320"  y="0.42283" line_mesh_count="128" line_mesh_power="4.5"/>
	<next_line x="0.7012"  y="0.20891" line_mesh_count="128" line_mesh_power="4.5"/>
	<next_line x="0.7212"  y="0.19463" line_mesh_count="128" line_mesh_power="4.5"/>
	<next_line x="0.83752"  y="0.19463" line_mesh_count="128" line_mesh_power="4.5"/>
	<next_line x="0.84752"  y="0.19463" line_mesh_count="128" line_mesh_power="4.5"/>
	<next_line x="0.96383"  y="0.14938" line_mesh_count="128" line_mesh_power="4.5"/>
	<next_line x="0.98883"  y="0.13113" line_mesh_count="128" line_mesh_power="4.5"/>
	<next_line x="1.8018"  y="0.13113" line_mesh_count="128" line_mesh_power="4.5"/>
      </poly_line>
    </rotated_poly_line_surface>
  </tag>

  <!-- magnets -->
  
  <tag name="magnet_tag">
    <cylinder_tube_space
    	name="mag_upstream_cylinder_space"
    	z1="-46.9985e-2"
    	z2="46.9985e-2"
	r1="15.0e-2"
	r2="16.0e-2"
    	longitudinal_mesh_count="200" longitudinal_mesh_power="3."
    	radial_mesh_count="80" radial_mesh_power="2."
        axial_mesh_count="128"
        />
  </tag>
  
  <tag name="magnet_tag">
    <cylinder_tube_space
    	name="mag_downstream_cylinder_space"
    	z1="-40.6485e-2"
    	z2="40.6485e-2"
	r1="20.0e-2"
	r2="21.0e-2"
    	longitudinal_mesh_count="200" longitudinal_mesh_power="3."
    	radial_mesh_count="80" radial_mesh_power="2."
        axial_mesh_count="128"
        />
  </tag>

  <!-- assembly -->

  <space name="ptolemy_assembly">

    <!-- helper surfaces -->
    
    <surface name="center" node="center_surface"/>

    <surface name="upstream_target" node="target">
      <transformation displacement="0. 0.  -1.45"/>
    </surface>
    <surface name="downstream_target" node="target">
      <transformation displacement="0. 0.  1.810"/>
    </surface>

    <!-- tritium source -->
    
    <surface name="source" node="tritium_source">
      <transformation displacement="0. 0. -1.398815"/>
    </surface>

    <!-- calorimeter -->
    
    <surface name="calorimeter" node="calorimeter_surface">
      <transformation displacement="0. 0. 1.805"/>
    </surface>

    <!-- electrodes -->

    <surface name="pre_cylinder" node="pre_cylinder_surface">
      <transformation displacement="0. 0. -1.45881"/>
    </surface>

    <surface name="pre_cone" node="pre_cone_surface">
      <transformation displacement="0. 0. -0.901865"/>
    </surface>

    <surface name="upstream_cylinder" node="upstream_cylinder_surface">
      <transformation displacement="0. 0. -0.77043"/>
    </surface>

    <surface name="upstream_cone" node="upstream_cone_surface">
      <transformation displacement="0. 0. -0.51298"/>
    </surface>

    <surface name="central_cylinder" node="central_cylinder_surface">
      <transformation displacement="0. 0. 0."/>
    </surface>

    <surface name="downstream_cone" node="downstream_cone_surface">
      <transformation displacement="0. 0. 0.5106"/>
    </surface>

    <surface name="downstream_cylinder" node="downstream_cylinder_surface">
      <transformation displacement="0. 0. 0.77936"/>
    </surface>

    <surface name="post_cone" node="post_cone_surface">
      <transformation displacement="0. 0. 0.905675"/>
    </surface>

    <surface name="post_cylinder" node="post_cylinder_surface">
      <transformation displacement="0. 0. 1.39532"/>
    </surface>

    <surface name="screen_all" node="screen_surface"/>

    <space name="mag_upstream_cylinder" node="mag_upstream_cylinder_space">
      <transformation displacement="0. 0. -1.45881"/>
    </space>
    <space name="mag_downstream_cylinder" node="mag_downstream_cylinder_space">
      <transformation displacement="0. 0. 1.39532"/>
    </space>

  </space>
  
  <space name="world" node="world_space">
    <space name="ptolemy" tree="ptolemy_assembly"/>
  </space>

    <!-- appearance -->

  <appearance name="app_electrode" color="255 127 0 127" arc="72" surfaces="world/ptolemy/@electrode_tag"/>
  <appearance name="app_screen" color="127 127 127 127" arc="72" surfaces="world/ptolemy/@screen_tag"/>
  <appearance name="app_source" color="255 0 0 127" arc="72" surfaces="world/ptolemy/@tritium_tag"/>
  <appearance name="app_calo" color="0 255 0 127" arc="72" surfaces="world/ptolemy/@calorimeter_tag"/>
  
  <appearance name="app_magnets" color="255 0 255 127" arc="72" surfaces="world/ptolemy/@magnet_tag"/>
  
  <!-- mesh -->

  <axial_mesh name="mesh_electrode" surfaces="world/ptolemy/@electrode_tag"/>
  <axial_mesh name="mesh_screen" surfaces="world/ptolemy/@screen_tag"/>

  <!-- bem  -->

  <electrostatic_dirichlet name="electrode_pre_cylinder"
			   surfaces="world/ptolemy/pre_cylinder"
			   value="18400.0"/>
  <electrostatic_dirichlet name="electrode_pre_cone"
			   surfaces="world/ptolemy/pre_cone"
			   value="14400.0"/>

  <electrostatic_dirichlet name="electrode_upstream_cylinder"
			   surfaces="world/ptolemy/upstream_cylinder"
			   value="14400.0"/>
  <electrostatic_dirichlet name="electrode_upstream_cone"
			   surfaces="world/ptolemy/upstream_cone"
			   value="8400.0"/>

  <electrostatic_dirichlet name="electrode_central_cylinder"
			   surfaces="world/ptolemy/central_cylinder"
			   value="200.0"/>

  <electrostatic_dirichlet name="electrode_downstream_cone"
			   surfaces="world/ptolemy/downstream_cone"
			   value="0.0"/>
  <electrostatic_dirichlet name="electrode_downstream_cylinder"
			   surfaces="world/ptolemy/downstream_cylinder"
			   value="8400.0"/>

  <electrostatic_dirichlet name="electrode_post_cone"
			   surfaces="world/ptolemy/post_cone"
			   value="12400.0"/>
  <electrostatic_dirichlet name="electrode_post_cylinder"
			   surfaces="world/ptolemy/post_cylinder"
			   value="14400.0"/>

  <electrostatic_dirichlet name="screenval"
			   surfaces="world/ptolemy/screen_all"
			   value="0.0"/>

  <electromagnet name="mag_coil_upstream" spaces="world/ptolemy/mag_upstream_cylinder" current="{3.3 * 500000}"/>
  <electromagnet name="mag_coil_downstream" spaces="world/ptolemy/mag_downstream_cylinder" current="{1.9 * 500000}"/>

</geometry>

<kassiopeia>

  <!-- magnetic fields -->

  <ksfield_electromagnet
      name="field_electromagnet"
      directory="[KEMFIELD_CACHE]"
      file="PTolemy1Magnets.kbd"
      system="world/ptolemy"
      spaces="world/ptolemy/@magnet_tag"
      >
    <zonal_harmonic_field_solver
        number_of_bifurcations="-1"
        convergence_ratio=".99"
        convergence_parameter="1.e-15"
        proximity_to_sourcepoint="1.e-12"
        number_of_central_coefficients="500"
        use_fractional_central_sourcepoint_spacing="true"
        central_sourcepoint_fractional_distance="1e-2"
        central_sourcepoint_spacing="1.e-3"
        number_of_remote_coefficients="200"
        remote_sourcepoint_start="-5.e-2"
        remote_sourcepoint_end="5.e-2"
        />
  </ksfield_electromagnet>
  
  <!-- electric fields -->

  <ksfield_electrostatic
      name="field_electrostatic"
      directory="[KEMFIELD_CACHE]"
      file="PTolemy1Electrodes.kbd"
      system="world/ptolemy"
      surfaces="world/ptolemy/@electrode_tag"
      symmetry="axial"
      >
    <robin_hood_bem_solver
        integrator="analytic"
        tolerance="1.e-10"
        check_sub_interval="100"
        display_interval="1"
        cache_matrix_elements="true"
        use_vtk="true"
        />
    <zonal_harmonic_field_solver
        number_of_bifurcations="-1"
        convergence_ratio=".99"
        convergence_parameter="1.e-15"
        proximity_to_sourcepoint="1.e-12"
        number_of_central_coefficients="500"
        use_fractional_central_sourcepoint_spacing="false"
        central_sourcepoint_spacing="1.e-3"
        central_sourcepoint_start="-5.2e-1"
        central_sourcepoint_end="5.2e-1"
        number_of_remote_coefficients="200"
        remote_sourcepoint_start="-5.e-2"
        remote_sourcepoint_end="5.e-2"
        />
  </ksfield_electrostatic>

  <ksfield_electric_constant
      name="field_constant"
      field="0. 0. 0."
      />

  <!-- generators -->

  <ksgen_generator_composite name="generator_uniform" pid="11">
    <energy_composite>
      <energy_fix value="18570.0"/>
    </energy_composite>
    <position_cylindrical_composite surface="world/ptolemy/source">
      <r_cylindrical radius_min="0." radius_max="1.5e-2"/>
      <phi_uniform value_min="0." value_max="360."/>
      <z_fix value="0."/>
    </position_cylindrical_composite>
    <direction_spherical_composite surface="world/ptolemy/source">
      <theta_uniform value_min="0." value_max="15."/>
      <phi_uniform value_min="0." value_max="360"/>
    </direction_spherical_composite>
    <time_composite>
      <time_fix value="0."/>
    </time_composite>
  </ksgen_generator_composite>

  <!-- trajectories-->

  <kstraj_trajectory_exact name="trajectory_exact">
    <interpolator_fast name="interpolator_fast"/>
    <integrator_rk8 name="integrator_rk8"/>
    <term_propagation name="term_propagation"/>
    <control_cyclotron name="control_cyclotron_1_64" fraction="{1. / 64.}"/>
    <control_time name="control_time" time="5.e-9"/>
  </kstraj_trajectory_exact>

  <!-- space navigators -->

  <ksnav_space name="nav_space" enter_split="false" exit_split="false"/>

  <!-- surface navigators -->

  <ksnav_surface name="nav_surface" transmission_split="false" reflection_split="false"/>

  <!-- terminators -->

  <ksterm_death name="term_upstream_target"/>
  <ksterm_death name="term_downstream_target"/>
  <ksterm_death name="term_world"/>
  <ksterm_max_steps name="term_max_steps" steps="1000000"/>

  <!-- writers -->

  <kswrite_root name="write_root" base="PTolemy1Simulation.root"/>
  <kswrite_vtk name="write_vtk" base="PTolemy1Simulation"/>

  <!-- output -->

  <ks_component_member name="component_track_initial_particle" field="initial_particle" parent="track"/>
  <ks_component_member name="component_track_final_particle" field="final_particle" parent="track"/>
  <ks_component_member name="component_track_position" field="position" parent="component_track_final_particle"/>
  <ks_component_member name="component_track_length" field="length" parent="component_track_final_particle"/>

  <ks_component_group name="component_track_world">
    <component_member name="creator_name" field="creator_name" parent="track"/>
    <component_member name="terminator_name" field="terminator_name" parent="track"/>
    <component_member name="total_steps" field="total_steps" parent="track"/>
    <component_member name="initial_time" field="time" parent="component_track_initial_particle"/>
    <component_member name="initial_position" field="position" parent="component_track_initial_particle"/>
    <component_member name="initial_momentum" field="momentum" parent="component_track_initial_particle"/>
    <component_member name="initial_magnetic_field" field="magnetic_field" parent="component_track_initial_particle"/>
    <component_member name="initial_electric_field" field="electric_field" parent="component_track_initial_particle"/>
    <component_member name="initial_electric_potential" field="electric_potential" parent="component_track_initial_particle"/>
    <component_member name="initial_kinetic_energy" field="kinetic_energy_ev" parent="component_track_initial_particle"/>
    <component_member name="initial_orbital_magnetic_moment" field="orbital_magnetic_moment" parent="component_track_initial_particle"/>
    <component_member name="initial_polar_angle_to_z" field="polar_angle_to_z" parent="component_track_initial_particle"/>
    <component_member name="initial_polar_angle_to_b" field="polar_angle_to_b" parent="component_track_initial_particle"/>
    <component_member name="final_time" field="time" parent="component_track_final_particle"/>
    <component_member name="final_position" field="position" parent="component_track_final_particle"/>
    <component_member name="final_momentum" field="momentum" parent="component_track_final_particle"/>
    <component_member name="final_magnetic_field" field="magnetic_field" parent="component_track_final_particle"/>
    <component_member name="final_electric_field" field="electric_field" parent="component_track_final_particle"/>
    <component_member name="final_electric_potential" field="electric_potential" parent="component_track_final_particle"/>
    <component_member name="final_kinetic_energy" field="kinetic_energy_ev" parent="component_track_final_particle"/>
    <component_member name="final_orbital_magnetic_moment" field="orbital_magnetic_moment" parent="component_track_final_particle"/>
    <component_member name="final_polar_angle_to_z" field="polar_angle_to_z" parent="component_track_final_particle"/>
    <component_member name="final_polar_angle_to_b" field="polar_angle_to_b" parent="component_track_final_particle"/>
  </ks_component_group>

  <ks_component_member name="component_step_final_particle" field="final_particle" parent="step"/>
  <ks_component_member name="component_step_position" field="position" parent="component_step_final_particle"/>
  <ks_component_member name="component_step_length" field="length" parent="component_step_final_particle"/>

  <ks_component_group name="component_step_world">
    <component_member name="step_id" field="step_id" parent="step"/>
    <component_member name="continuous_time" field="continuous_time" parent="step"/>
    <component_member name="continuous_length" field="continuous_length" parent="step"/>
    <component_member name="time" field="time" parent="component_step_final_particle"/>
    <component_member name="position" field="position" parent="component_step_final_particle"/>
    <component_member name="momentum" field="momentum" parent="component_step_final_particle"/>
    <component_member name="magnetic_field" field="magnetic_field" parent="component_step_final_particle"/>
    <component_member name="electric_field" field="electric_field" parent="component_step_final_particle"/>
    <component_member name="electric_potential" field="electric_potential" parent="component_step_final_particle"/>
    <component_member name="kinetic_energy" field="kinetic_energy_ev" parent="component_step_final_particle"/>
    <component_member name="orbital_magnetic_moment" field="orbital_magnetic_moment" parent="component_step_final_particle"/>
    <component_member name="polar_angle_to_z" field="polar_angle_to_z" parent="component_step_final_particle"/>
    <component_member name="polar_angle_to_b" field="polar_angle_to_b" parent="component_step_final_particle"/>
  </ks_component_group>

  <!-- structure -->

  <ksgeo_space name="space_world" spaces="world">
    <command parent="root_terminator" field="add_terminator" child="term_max_steps"/>
    <command parent="root_terminator" field="remove_terminator" child="term_world"/>
    <command parent="write_root" field="add_track_output" child="component_track_world"/>
    <command parent="write_root" field="add_step_output" child="component_step_world"/>
    <command parent="write_vtk" field="set_track_point" child="component_track_position"/>
    <command parent="write_vtk" field="set_track_data" child="component_track_length"/>
    <command parent="write_vtk" field="set_step_point" child="component_step_position"/>
    <command parent="write_vtk" field="set_step_data" child="component_step_length"/>
    <geo_surface name="surface_upstream_target" surfaces="world/ptolemy/upstream_target">
      <command parent="root_terminator" field="add_terminator" child="term_upstream_target"/>
    </geo_surface>
    <geo_surface name="surface_downstream_target" surfaces="world/ptolemy/downstream_target">
      <command parent="root_terminator" field="add_terminator" child="term_downstream_target"/>
    </geo_surface>
    <geo_surface name="surface_center" surfaces="world/ptolemy/center"/>
  </ksgeo_space>

  <!-- simulation -->

  <ks_simulation
      run="1"
      seed="51385"
      events="1"
      magnetic_field="field_electromagnet"
      electric_field="field_electrostatic"
      space="space_world"
      generator="generator_uniform"
      trajectory="trajectory_exact"
      space_navigator="nav_space"
      surface_navigator="nav_surface"
      terminator="term_world"
      writer="write_root"
      writer="write_vtk"
      />

</kassiopeia>

<vtk_window
    name="vtk_window"
    enable_display="true"
    enable_write="true"
    frame_title="KGeoBag Visualization"
    frame_size_x="1024"
    frame_size_y="768"
    frame_color_red=".2"
    frame_color_green=".2"
    frame_color_blue=".2"
    view_angle="45"
    eye_angle="0.5"
    multi_samples="4"
    depth_peeling="10"
    >
  <vtk_geometry_painter
      name="geometry_painter"
      file="PTolemy1Geometry.vtp"
      surfaces="world/ptolemy/#"
      />
  <vtk_track_painter
      name="track_painter"
      file="PTolemy1Simulation.root"
      point_object="component_step_world"
      point_variable="position"
      color_object="component_step_world"
      color_variable="polar_angle_to_b"
      />
  <vtk_track_terminator_painter
      name="terminator_painter"
      file="PTolemy1Simulation.root"
      point_object="component_track_world"
      point_variable="final_position"
      terminator_object="component_track_world"
      terminator_variable="terminator_name"
      add_terminator="term_upstream_target"
      add_color="0 255 0"
      add_terminator="term_downstream_target"
      add_color="0 255 0"
      add_terminator="term_max_steps"
      add_color="255 0 0"
      />
</vtk_window>
