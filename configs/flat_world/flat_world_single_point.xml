<define name="output_path" value="[KASPERSYS]/output/Kassiopeia"/>
<define name="log_path" value="[KASPERSYS]/log/Kassiopeia"/>
<define name="geometry_file_path" value="."/>

<!-- Simulation parameters -->
<external_define name="run_id" value="0"/>
<external_define name="seed" value="78797"/>
<external_define name="output_file" value="flat_world_single_point"/>
<external_define name="events" value="1"/>
<external_define name="n_steps" value="250000"/>

<!-- B field parameters (B0, lambda, N/A)-->
<external_define name="bx0" value="1"/>
<external_define name="bx1" value="0.05"/>
<external_define name="bx2" value="0"/>

<!-- Vertical E field parameters (E0, lambda, N/A) -->
<external_define name="ey0" value="526087.45"/>
<external_define name="ey1" value="0.05"/>
<external_define name="ey2" value="0"/>

<!-- Parallel E field parameters (k, D, x0) -->
<external_define name="epar0" value="0"/>
<external_define name="epar1" value="0.005"/>
<external_define name="epar2" value="0"/>

<!-- Initial state of electron-->
<external_define name="pitch" value="90"/>
<external_define name="phi" value="0"/>

<external_define name="x" value="0"/>
<external_define name="y" value="-0.19634954"/>
<external_define name="z" value="0"/>

<!-- Dimensions of cylinder space-->
<external_define name="zlim" value="1"/>
<external_define name="radius" value=".3"/>

<define name="filename" value="[output_file]_Ey_[ey0]_[ey1]_Epar_[epar0]_[epar1]_[epar2]_B_[bx0]_[bx1]_P_[x]:[y]:[z]_phi_[phi]_pitch_[pitch]_events_[events]_dim_[zlim]:[radius]_run_[run_id]"/>


<messages>
  <file path="[log_path]" base="[filename].txt"/>

  <message key="k_file" terminal="normal" log="warning"/>
  <message key="k_initialization" terminal="normal" log="warning"/>

  <message key="kg_core" terminal="normal" log="warning"/>
  <message key="kg_shape" terminal="normal" log="warning"/>
  <message key="kg_mesh" terminal="normal" log="warning"/>
  <message key="kg_axial_mesh" terminal="normal" log="warning"/>

  <message key="ks_object" terminal="normal" log="normal"/>
  <message key="ks_operator" terminal="normal" log="normal"/>
  <message key="ks_field" terminal="normal" log="normal"/>
  <message key="ks_geometry" terminal="normal" log="normal"/>
  <message key="ks_generator" terminal="normal" log="normal"/>
  <message key="ks_trajectory" terminal="normal" log="normal"/>
  <message key="ks_interaction" terminal="normal" log="normal"/>
  <message key="ks_navigator" terminal="normal" log="normal"/>
  <message key="ks_terminator" terminal="normal" log="normal"/>
  <message key="ks_writer" terminal="normal" log="normal"/>
  <message key="ks_main" terminal="normal" log="normal"/>
  <message key="ks_run" terminal="normal" log="normal"/>
  <message key="ks_event" terminal="normal" log="normal"/>
  <message key="ks_track" terminal="normal" log="normal"/>
  <message key="ks_step" terminal="normal" log="normal"/>

</messages>

<include name="[geometry_file_path]/flat_world_geom.xml"/>

<kassiopeia>

  <!-- fields -->

  <ksfield_magnetic_expo name="B_expo" Bx="[bx0] [bx1] [bx2]"/>
  <ksfield_electric_expo name="E_expo"  Ey="[ey0] [ey1] [ey2]" Epar="[epar0] [epar1] [epar2]"/>

  <!-- generators -->

  <ksgen_generator_composite name="generator_uniform" pid="11">
    <energy_composite>
      <energy_fix value="18600."/>
    </energy_composite>
    <position_rectangular_composite surface="world/exb_setup/target">
      <x_fix value="[z]"/>
      <y_fix value="[y]"/>
      <z_fix value="[x]"/>
    </position_rectangular_composite>
    <direction_spherical_composite surface="world/exb_setup/target">
      <theta_fix value="[pitch]"/>
      <phi_fix value="[phi]"/>
    </direction_spherical_composite>
    <time_composite>
      <time_fix value="0"/>
    </time_composite>
  </ksgen_generator_composite>

  <!-- trajectories-->

  <kstraj_trajectory_exact name="trajectory_exact">
    <interpolator_crk name="interpolator_crk"/>
    <integrator_rk8 name="integrator_rk8"/>
    <term_propagation name="term_propagation"/>
    <control_cyclotron name="control_cyclotron_1_64" fraction="{1. / 64.}"/>
    <control_time name="control_time" time="5.e-9"/>
  </kstraj_trajectory_exact>

  <!-- space navigators -->

  <ksnav_space name="nav_space" enter_split="false" exit_split="false"/>

  <!-- surface navigators -->

  <ksnav_surface name="nav_surface" transmission_split="false" reflection_split="false"/>

  <!-- terminators -->

  <ksterm_death name="term_fence"/>
  <ksterm_death name="term_catcher"/>
  <ksterm_death name="term_world"/>
  <ksterm_max_steps name="term_max_steps" steps="[n_steps]"/>

  <!-- writers -->

  <kswrite_root name="write_root" path="[output_path]" base="[filename].root"/>

  <!-- output -->

  <ks_component_member name="component_track_initial_particle" 	field="initial_particle" 	        parent="track"/>
  <ks_component_member name="component_track_final_particle" 	field="final_particle" 		        parent="track"/>
  <ks_component_member name="component_track_position" 		    field="position" 		            parent="component_track_final_particle"/>
  <ks_component_member name="component_track_length"    		field="length" 		    	        parent="component_track_final_particle"/>

  <ks_component_group name="component_track_world">
    <component_member name="creator_name" 	            		field="creator_name" 		        parent="track"/>
    <component_member name="terminator_name" 			        field="terminator_name" 	        parent="track"/>
    <component_member name="total_steps" 			            field="total_steps" 		        parent="track"/>
    <component_member name="initial_time" 			            field="time" 			            parent="component_track_initial_particle"/>
    <component_member name="initial_position"        			field="position" 		            parent="component_track_initial_particle"/>
    <component_member name="initial_momentum" 		        	field="momentum" 		            parent="component_track_initial_particle"/>
    <component_member name="initial_magnetic_field" 	    	field="magnetic_field" 		        parent="component_track_initial_particle"/>
    <component_member name="initial_electric_field" 		    field="electric_field" 		        parent="component_track_initial_particle"/>
    <component_member name="initial_electric_potential" 	    field="electric_potential" 	        parent="component_track_initial_particle"/>
    <component_member name="initial_kinetic_energy" 		    field="kinetic_energy_ev" 	        parent="component_track_initial_particle"/>
    <component_member name="initial_orbital_magnetic_moment" 	field="orbital_magnetic_moment"     parent="component_track_initial_particle"/>
    <component_member name="initial_polar_angle_to_z" 		    field="polar_angle_to_z" 	        parent="component_track_initial_particle"/>
    <component_member name="initial_polar_angle_to_b" 		    field="polar_angle_to_b" 	        parent="component_track_initial_particle"/>
    <component_member name="final_time" 			            field="time" 			            parent="component_track_final_particle"/>
    <component_member name="final_position" 			        field="position"            		parent="component_track_final_particle"/>
    <component_member name="final_momentum" 			        field="momentum" 	            	parent="component_track_final_particle"/>
    <component_member name="final_magnetic_field" 		        field="magnetic_field" 		        parent="component_track_final_particle"/>
    <component_member name="final_electric_field" 		        field="electric_field" 		        parent="component_track_final_particle"/>
    <component_member name="final_electric_potential" 		    field="electric_potential" 	        parent="component_track_final_particle"/>
    <component_member name="final_kinetic_energy" 		        field="kinetic_energy_ev" 	        parent="component_track_final_particle"/>
    <component_member name="final_orbital_magnetic_moment" 	    field="orbital_magnetic_moment"     parent="component_track_final_particle"/>
    <component_member name="final_polar_angle_to_z" 		    field="polar_angle_to_z" 	        parent="component_track_final_particle"/>
    <component_member name="final_polar_angle_to_b" 		    field="polar_angle_to_b" 	        parent="component_track_final_particle"/>
  </ks_component_group>

  <ks_component_member name="component_step_final_particle"     field="final_particle" 		        parent="step"/>
  <ks_component_member name="component_step_position"       	field="position" 			        parent="component_step_final_particle"/>
  <ks_component_member name="component_step_length" 	        field="length" 				        parent="component_step_final_particle"/>

  <ks_component_group name="component_step_world">
    <component_member name="step_id" 			                field="step_id" 			        parent="step"/>
    <component_member name="continuous_time" 		            field="continuous_time" 		    parent="step"/>
    <component_member name="continuous_length" 		            field="continuous_length" 		    parent="step"/>
    <component_member name="time" 			                    field="time" 				        parent="component_step_final_particle"/>
    <component_member name="position" 			                field="position" 			        parent="component_step_final_particle"/>
    <component_member name="velocity" 			                field="velocity" 			        parent="component_step_final_particle"/>
    <component_member name="trans_velocity" 	            	field="trans_velocity" 			    parent="component_step_final_particle"/>
    <component_member name="long_velocity"		                field="long_velocity"			    parent="component_step_final_particle"/>
    <component_member name="momentum" 			                field="momentum" 			        parent="component_step_final_particle"/>
    <component_member name="trans_momentum"		                field="trans_momentum" 			    parent="component_step_final_particle"/>
    <component_member name="long_momentum"		                field="long_momentum"			    parent="component_step_final_particle"/>
    <component_member name="magnetic_field" 		            field="magnetic_field" 			    parent="component_step_final_particle"/>
    <component_member name="magnetic_gradient" 		            field="magnetic_gradient" 		    parent="component_step_final_particle"/>
    <component_member name="electric_field" 		            field="electric_field" 			    parent="component_step_final_particle"/>
    <component_member name="electric_potential"             	field="electric_potential" 		    parent="component_step_final_particle"/>
    <component_member name="kinetic_energy" 		            field="kinetic_energy_ev" 		    parent="component_step_final_particle"/>
    <component_member name="orbital_magnetic_moment" 	        field="orbital_magnetic_moment" 	parent="component_step_final_particle"/>
    <component_member name="polar_angle_to_z" 		            field="polar_angle_to_z" 		    parent="component_step_final_particle"/>
    <component_member name="polar_angle_to_b" 		            field="polar_angle_to_b" 		    parent="component_step_final_particle"/>
    <component_member name="cyclotron_frequency" 	            field="cyclotron_frequency"	        parent="component_step_final_particle"/>
    <component_member name="guiding_center_position"        	field="guiding_center_position" 	parent="component_step_final_particle"/>
    <component_member name="azimuthal_angle_to_x" 	            field="azimuthal_angle_to_x" 		parent="component_step_final_particle"/>
    <component_member name="lorentz_factor" 		            field="lorentz_factor   " 			parent="component_step_final_particle"/>
    <component_member name="speed"	 		                    field="speed"	 			        parent="component_step_final_particle"/>
  </ks_component_group>

  <!-- structure -->

  <ksgeo_space name="space_world" spaces="world">
    <command parent="root_terminator"   field="add_terminator"      child="term_max_steps"/>
    <command parent="root_terminator"   field="remove_terminator"   child="term_world"/>
    <command parent="write_root"        field="add_track_output"    child="component_track_world"/>
    <command parent="write_root"        field="add_step_output"     child="component_step_world"/>

    <geo_surface name="surface_catcher" surfaces="world/exb_setup/@catcher_tag">
      <command parent="root_terminator" field="add_terminator"      child="term_catcher"/>
    </geo_surface>
    
    <geo_surface name="surface_fence" surfaces="world/exb_setup/fence_side">
      <command parent="root_terminator" field="add_terminator"      child="term_fence"/>
    </geo_surface>
    
    <geo_surface name="surface_fence_top" surfaces="world/exb_setup/fence_top">
      <command parent="root_terminator" field="add_terminator"      child="term_fence"/>
    </geo_surface>
    
    <geo_surface name="surface_fence_bot" surfaces="world/exb_setup/fence_bot">
      <command parent="root_terminator" field="add_terminator"      child="term_fence"/>
    </geo_surface>
 
  </ksgeo_space>

  <!-- simulation -->

  <ks_simulation
      run="[run_id]"
      seed="[seed]"
      events="[events]"
      magnetic_field="B_expo"
      electric_field="E_expo"
      space="space_world"
      generator="generator_uniform"
      trajectory="trajectory_exact"
      space_navigator="nav_space"
      surface_navigator="nav_surface"
      terminator="term_world"
      writer="write_root"
      />

</kassiopeia>
